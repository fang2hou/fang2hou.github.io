<!doctype html><html dir=ltr lang=zh-cn data-theme><head><title>fang2hou | ä½¿ç”¨ Google Colab æä¾›çš„å…è´¹ TPU è¿›è¡Œè®­ç»ƒ</title><meta charset=utf-8><meta name=generator content="Hugo 0.81.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="ç¡•å£«ç ”ç©¶ç”Ÿ @ ç­‘æ³¢å¤§å­¦
å…¨æ ˆå·¥ç¨‹å¸ˆ
"><link rel=stylesheet href=/css/style.min.51d7ec6db610dce512b735d5315f963c278042d026aa4ebe05a9355460b49016.css integrity="sha256-UdfsbbYQ3OUStzXVMV+WPCeAQtAmqk6+Bak1VGC0kBY=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.f7543874fd85ac54022e92bff1f3e54326ad7a136685439729114cd42b44ed2c.css integrity="sha256-91Q4dP2FrFQCLpK/8fPlQyatehNmhUOXKRFM1CtE7Sw=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/fang2hou.min.3296d14717c4a9ba650c1d7b8968751d67720f2a33c1d0579fe7625449be209c.css integrity="sha256-MpbRRxfEqbplDB17iWh1HWdyDyozwdBXn+diVEm+IJw=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=/post/use-tpu-to-train-cnn/><script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script><script type=text/javascript src=/js/custom.min.690f1ddb8799856cb1eba93ecb8ac2f1fccdf234bd330ce5132d13159df76851.js integrity="sha256-aQ8d24eZhWyx66k+y4rC8fzN8jS9MwzlEy0TFZ33aFE=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="ä½¿ç”¨ Google Colab æä¾›çš„å…è´¹ TPU è¿›è¡Œè®­ç»ƒ"><meta name=twitter:description content="å‰è¨€
æ¯”èµ·æ·±åº¦å­¦ä¹ æœ€åˆçš„ CPU è®¡ç®—ï¼Œç°åœ¨æ™®éä½¿ç”¨ GPU æ¥è¿›è¡Œè®­ç»ƒï¼Œæ•ˆç‡æå‡å·²ç„¶æ˜¯ç›¸å½“æ˜æ˜¾ã€‚ä½†æ˜¯åƒæ˜¯ Google å’Œé˜¿é‡Œå·´å·´è¿™äº›ç§‘æŠ€å·¨å¤´è¿˜æ˜¯ä¸æ»¡è¶³è¿™äº›ï¼Œç›´æ¥è®©æ—¥å¸¸ä½¿ç”¨ä»‹å…¥èŠ¯ç‰‡ç ”å‘ï¼ŒGoogle æå‡º TPU æ–¹æ¡ˆï¼Œé˜¿é‡Œä¹Ÿæˆç«‹äº†å¹³å¤´å“¥ç‹¬ç«‹å“ç‰Œæ¥å‘å¸ƒæ–°å“ã€‚å®˜æ–¹è¯´æ³•æ˜¯å¯¹äºç›®å‰é¡¶å°– GPU éƒ½æœ‰ 20 å€ä»¥ä¸Šçš„ç®—åŠ›æå‡ã€‚
é˜¿é‡Œå’Œ Google çš„èŠ¯ç‰‡æŠ€æœ¯éƒ½å·²ç»å®è£…è¿ç”¨åœ¨äº†è‡ªå®¶çš„äº‘æœåŠ¡ä¸Šï¼Œä¸è¿‡æœ‰å¹¸çš„æ˜¯ï¼ŒGoogle åœ¨è‡ªå®¶æ¨å‡ºçš„ Colab æœºå™¨å­¦ä¹ å¹³å°ä¹‹ä¸­æä¾›äº†å…è´¹è¯•ç”¨ TPU çš„æœºä¼šã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šä»‹ç»ä¸€ä¸‹å½“ä¸‹ï¼Œå¿«é€Ÿä½¿ç”¨ Keras è¿›è¡Œè®­ç»ƒçš„ä¸€ä¸ªå®ä¾‹ã€‚
åœ¨çœ‹ä¸‹é¢çš„æ–‡å­—çš„ä¹‹å‰ï¼Œæœ€å¥½å›å¿†ä¸€ä¸‹ç®€å•çš„ CNN æ„é€ ã€‚å¦‚æœä½ æœ‰ä¸€äº› Keras æˆ–æ˜¯ TensorFlow ç›¸å…³çš„ä½¿ç”¨ç»éªŒï¼Œé‚£ä¹ˆåº”è¯¥èƒ½å¤Ÿéå¸¸å¿«é€Ÿçš„ç†è§£ã€‚"></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class=title><div class=avatar><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 61.47 85.63"><defs><style>.cls-1,.cls-2{fill:none}.cls-1,.cls-2,.cls-3,.cls-4{stroke:#231f20;stroke-miterlimit:10}.cls-2,.cls-4{stroke-linecap:round}</style></defs><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><path class="cls-1" d="M31.91 85.13c6.64-.19 11.15-5 14.08-8.15a34.76 34.76.0 008-15.11c1.09-4 .87-8.1 1.51-12.18C56.08 46 56.84 45.12 58 41l.13-.45a111.64 111.64.0 002.81-13.95c.46-6.7-4.42-14.78-10.36-19.65C41-1 29.61.49 27 .83A32.75 32.75.0 008.66 9.72c-2.31 2.26-6.13 6-7.56 12-2 8.23 1.37 17.47 3.26 21 0 .09.4.79.79 1.78.0.0.32.79.59 1.61A37.5 37.5.0 017.13 54.5 38.17 38.17.0 009.84 65.87a31.37 31.37.0 008.3 12.74c2.86 2.56 7.46 6.7 13.77 6.52z"/><path class="cls-2" d="M52.5 36.25c-5.33-5.34-14.37-1.81-14.37-1.81"/><path class="cls-2" d="M10.33 36.25c5.33-5.34 14.37-1.81 14.37-1.81"/><path class="cls-1" d="M15.74 54.45c.28.07 6.37 1.43 10.24-2.84.18-.19 3.84-4.33 2.25-7.91-1.45-3.28-6.19-3.59-8.86-3.77-3.5-.23-9.22.44-10.18 3.27a8.9 8.9.0 00.16 2.27c0 .1.0.21.0.32a33.7 33.7.0 001.13 5.31C11.85 53.51 14.8 54.22 15.74 54.45z"/><path class="cls-1" d="M47.28 54.45c-.28.07-6.36 1.43-10.23-2.84-.18-.19-3.84-4.33-2.25-7.91 1.45-3.28 6.18-3.59 8.86-3.77 3.5-.23 9.22.44 10.18 3.27.24.73-.93 7.16-1.34 7.9C51.18 53.51 48.23 54.22 47.28 54.45z"/><line class="cls-1" x1="28.63" y1="45.79" x2="34.4" y2="45.79"/><path class="cls-2" d="M23.51 69a24.85 24.85.0 007.92 1.55 23.63 23.63.0 008.09-1.39"/><path class="cls-1" d="M58 41a11.27 11.27.0 011.32 3.14c.55 2.19.23 4-.44 7.41-.75 3.86-1.47 4.87-1.89 5.37a7.73 7.73.0 01-2.39 1.9"/><path class="cls-2" d="M3.79 41a10.7 10.7.0 00-1.32 3.14c-.55 2.19-.23 4 .44 7.41.75 3.86 1.47 4.87 1.89 5.37a7.71 7.71.0 002.38 1.9"/><path class="cls-3" d="M50.58 6.9C41-1 29.61.49 27 .83A32.75 32.75.0 008.66 9.72c-2.31 2.26-6.13 6-7.56 12-2 8.23 1.37 17.47 3.26 21 0 .09.4.79.79 1.78.0.0.32.79.59 1.61.21.66.39 1.34.54 2a21 21 0 00.6-3.65c.24-3.61-.86-4-.74-8.74.06-2.47.24-9.92 4.15-11.85 1.55-.77 2.42.0 5.18.15 9.35.63 19.67-6.32 23.26-8.74a3.39 3.39.0 012.07-.89c3.55.18 3.42 9.28 10.37 14.37 1.78 1.3 2.32 1.1 3.41 2.37 3 3.48 1.28 7.75 2.08 11.41A7.72 7.72.0 0057.07 44c.28-.82.58-1.77.93-3l.13-.45a111.64 111.64.0 002.81-13.95C61.4 19.85 56.52 11.77 50.58 6.9z"/><path class="cls-2" d="M26.18 59.9a3.44 3.44.0 011.28-.18c1 .07 1.28.66 2.23 1.05a4.91 4.91.0 003.19.0c1.13-.39 1.24-1 2.26-1.21a3.5 3.5.0 012.06.31"/><path class="cls-1" d="M6.4 48.74c-.74-2.83 2.95-3.27 2.95-3.27"/><path class="cls-1" d="M55.82 48a2.57 2.57.0 00-2.07-3.1"/><path class="cls-2" d="M24.33 45.6c-1.82-2.56-8.19-1.65-9-.25"/><path class="cls-4" d="M18.63 45.58c0 1.83 3.05 1.83 3 0s-3.03-1.83-3 0z"/><path class="cls-2" d="M39.62 45.3c1.82-2.56 8.19-1.65 9-.24"/><path class="cls-4" d="M45.32 45.28c0 1.84-3 1.84-3 0s3.03-1.83 3 0z"/></g></g></svg></div><h3 title><a href=/>æ–¹èˆŸ</a></h3><div class=description><p>ç¡•å£«ç ”ç©¶ç”Ÿ @ ç­‘æ³¢å¤§å­¦<br>å…¨æ ˆå·¥ç¨‹å¸ˆ<br></p></div></div></div><ul class=social-links><li><a href=https://www.linkedin.com/in/zhou-fang-cn/ rel=me aria-label=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li><a href=https://github.com/fang2hou/ rel=me aria-label=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=https://twitter.com/fang2hou rel=me aria-label=twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li><a href=mailto:iszhoufang@gmail.com rel=me aria-label=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><div class=lang-switcher><p id=lang-notification></p><ul><li><a href=https://fang2hou.com/ onmouseover='languageNotify("ä¸­æ–‡")' onmouseleave=languageNotify(null) onclick='setLanguage("zh-cn")'><img class=flag src=/images/flags/zh-cn.svg></a></li><li><a href=https://fang2hou.com/ja/ onmouseover='languageNotify("æ—¥æœ¬èª")' onmouseleave=languageNotify(null) onclick='setLanguage("ja")'><img class=flag src=/images/flags/ja.svg></a></li><li><a href=https://fang2hou.com/en/ onmouseover='languageNotify("English")' onmouseleave=languageNotify(null) onclick='setLanguage("en")'><img class=flag src=/images/flags/en.svg></a></li></ul></div><div class=author>&copy; fang2hou 2012-2021</div></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/ title>å…³äº</a></li><li><a href=/post/ title>æ–‡ç« </a></li><li><a href=/project/ title>é¡¹ç›®</a></li><li class=lang-switcher-nav><a href=/ title=ä¸­æ–‡><img class=flag src=/images/flags/zh-cn.svg> ä¸­æ–‡</a></li><li class=lang-switcher-nav><a href=/ja/ title=æ—¥æœ¬èª><img class=flag src=/images/flags/ja.svg> æ—¥æœ¬èª</a></li><li class=lang-switcher-nav><a href=/en/ title=English><img class=flag src=/images/flags/en.svg> English</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"><div class=post-content><div class=post-title><h3>ä½¿ç”¨ Google Colab æä¾›çš„å…è´¹ TPU è¿›è¡Œè®­ç»ƒ</h3><div class=info>ğŸ“…&nbsp;
<span class=date>2019 å¹´ 10 æœˆ 9 æ—¥</span>
ğŸ“–&nbsp;
<span class=reading-time>é˜…è¯»æ—¶é—´ 3 åˆ†é’Ÿ</span></div></div><h1 id=å‰è¨€>å‰è¨€</h1><p>æ¯”èµ·æ·±åº¦å­¦ä¹ æœ€åˆçš„ CPU è®¡ç®—ï¼Œç°åœ¨æ™®éä½¿ç”¨ GPU æ¥è¿›è¡Œè®­ç»ƒï¼Œæ•ˆç‡æå‡å·²ç„¶æ˜¯ç›¸å½“æ˜æ˜¾ã€‚ä½†æ˜¯åƒæ˜¯ Google å’Œé˜¿é‡Œå·´å·´è¿™äº›ç§‘æŠ€å·¨å¤´è¿˜æ˜¯ä¸æ»¡è¶³è¿™äº›ï¼Œç›´æ¥è®©æ—¥å¸¸ä½¿ç”¨ä»‹å…¥èŠ¯ç‰‡ç ”å‘ï¼ŒGoogle æå‡º TPU æ–¹æ¡ˆï¼Œé˜¿é‡Œä¹Ÿæˆç«‹äº†å¹³å¤´å“¥ç‹¬ç«‹å“ç‰Œæ¥å‘å¸ƒæ–°å“ã€‚å®˜æ–¹è¯´æ³•æ˜¯å¯¹äºç›®å‰é¡¶å°– GPU éƒ½æœ‰ 20 å€ä»¥ä¸Šçš„ç®—åŠ›æå‡ã€‚<br>é˜¿é‡Œå’Œ Google çš„èŠ¯ç‰‡æŠ€æœ¯éƒ½å·²ç»å®è£…è¿ç”¨åœ¨äº†è‡ªå®¶çš„äº‘æœåŠ¡ä¸Šï¼Œä¸è¿‡æœ‰å¹¸çš„æ˜¯ï¼ŒGoogle åœ¨è‡ªå®¶æ¨å‡ºçš„ Colab æœºå™¨å­¦ä¹ å¹³å°ä¹‹ä¸­æä¾›äº†å…è´¹è¯•ç”¨ TPU çš„æœºä¼šã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šä»‹ç»ä¸€ä¸‹å½“ä¸‹ï¼Œå¿«é€Ÿä½¿ç”¨ Keras è¿›è¡Œè®­ç»ƒçš„ä¸€ä¸ªå®ä¾‹ã€‚<br>åœ¨çœ‹ä¸‹é¢çš„æ–‡å­—çš„ä¹‹å‰ï¼Œæœ€å¥½å›å¿†ä¸€ä¸‹ç®€å•çš„ CNN æ„é€ ã€‚å¦‚æœä½ æœ‰ä¸€äº› Keras æˆ–æ˜¯ TensorFlow ç›¸å…³çš„ä½¿ç”¨ç»éªŒï¼Œé‚£ä¹ˆåº”è¯¥èƒ½å¤Ÿéå¸¸å¿«é€Ÿçš„ç†è§£ã€‚</p><h1 id=é…ç½®-colab-ç¯å¢ƒ>é…ç½® Colab ç¯å¢ƒ</h1><p>æ‰“å¼€ <a href=https://colab.research.google.com>https://colab.research.google.com</a>ï¼Œç™»é™†è°·æ­Œè´¦æˆ·å°±å¯ä»¥ç›´æ¥å¯åŠ¨ä¸€ä¸ªå…¨æ–°çš„è¿è¡Œå®ä¾‹ã€‚<br>ç”±äºæ˜¯è¦ä½¿ç”¨ TPUï¼Œæ‰€ä»¥è¿˜è¦åœ¨èœå•æ ä¸­çš„ <code>Runtime</code> -> <code>Change runtime type</code> æ‰‹åŠ¨è®¾å®šç¯å¢ƒä¸º Python 3ï¼Œç¡¬ä»¶åŠ é€Ÿä¸º TPUã€‚</p><p><img src=change_runtime.png alt=æ‰‹åŠ¨ä¿®æ”¹ç¯å¢ƒ></p><p>Colab ä¸ä½†å¯ä»¥æ‰¿æ‹… Jupyter Notebook çš„å·¥ä½œï¼Œå…¶å® Google è¿˜ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªè™šæ‹Ÿæœºã€‚</p><p>åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒTensorFlow çš„æ­£å¼ç‰ˆæœ¬ä¸º 1.14ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„ Keras æ”¯æŒè®­ç»ƒå‘½ä»¤(<code>model.fit_generator</code>)ç›®å‰åªé€‚é…åˆ° 1.13ï¼Œæ‰€ä»¥å…ˆè¿›è¡Œé™çº§ã€‚<br>åœ¨ç¬¬ä¸€ä¸ª Code cell é‡Œå¡«å…¥ä¸‹é¢çš„ä»£ç æ¥å®ç°é™çº§ï¼Œç”±äºè¦å…ˆå¸è½½æ‰ 1.14ï¼Œå¾—ç¨å¾®ç­‰å¾…ä¸€ä¸‹ã€‚</p><pre><code class=language-bash># Downgrade tf to 1.13.1
!pip install tensorflow==1.13.1
</code></pre><p>åœ¨é™çº§æˆåŠŸåï¼ŒColab ä¼šåœ¨è¾“å‡ºä¹‹ä¸­ä¼šæç¤ºè®©ä½ è¿›è¡Œä¸€æ¬¡è¿è¡Œå®ä¾‹é‡å¯ï¼Œç‚¹å‡» <code>RESTART RUNTIME</code> å³å¯ã€‚<br>æœ‰æ—¶å€™æ²¡æœ‰æç¤ºçš„è¯ï¼Œå°±é€šè¿‡ <code>Runtime</code> -> <code>Restart runtime...</code> é‡å¯ã€‚</p><h1 id=ä¸‹è½½æ•°æ®é›†>ä¸‹è½½æ•°æ®é›†</h1><p>åœ¨ç¬¬äºŒä¸ª Code cell é‡Œå¡«å…¥ä¸‹é¢çš„ä»£ç æ¥ä¸‹è½½å…¬å¼€çš„æµ‹è¯•æ•°æ®é›†ï¼ˆçŒ«ç‹—å¤§æˆ˜ï¼ŒçŒ«ç‹—å„ 4000 è®­ç»ƒé›† + 1000 æµ‹è¯•é›†ï¼‰ã€‚</p><pre><code class=language-bash># Download and unzip dataset
!wget https://sds-platform-private.s3-us-east-2.amazonaws.com/uploads/P16-Convolutional-Neural-Networks.zip
!unzip -qq P16-Convolutional-Neural-Networks.zip &quot;Convolutional_Neural_Networks/dataset/*&quot;
!mv Convolutional_Neural_Networks/dataset dataset
!rm -rf Convolutional_Neural_Networks
</code></pre><h1 id=å¯¼å…¥åº“>å¯¼å…¥åº“</h1><p>è¿™é‡Œå¯¼å…¥ <code>os</code> åº“ç”¨äº TPU æ”¯æŒç›¸å…³è¯­å¥ã€‚<br><strong>æ³¨æ„ï¼šè™½ç„¶æˆ‘ä»¬æ˜¯å†™ Keras ä»£ç ï¼Œä½†è¿™é‡Œä¸èƒ½ç›´æ¥ä½¿ç”¨ <code>keras</code> åº“ä¸­çš„æ¨¡å‹ï¼Œè€Œæ˜¯è¦ä½¿ç”¨ <code>tensorflow.keras</code>ã€‚</strong></p><pre><code class=language-python>import os
import tensorflow as tf
from tensorflow.contrib.tpu.python.tpu import keras_support
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv2D, MaxPooling2D, Flatten, Dense, Dropout
from keras.preprocessing.image import ImageDataGenerator
</code></pre><h1 id=æ•°æ®é›†é¢„å¤„ç†>æ•°æ®é›†é¢„å¤„ç†</h1><pre><code class=language-python># Image processing
train_datagen = ImageDataGenerator(rescale=1. /255,
                                   shear_range=0.2,
                                   zoom_range=0.2,
                                   horizontal_flip=True)

test_datagen = ImageDataGenerator(rescale=1. / 255)

train_data = train_datagen.flow_from_directory('dataset/training_set',
                                               target_size=(128, 128),
                                               batch_size=32,
                                               class_mode='binary')

validation_data = test_datagen.flow_from_directory('dataset/test_set',
                                                   target_size=(128, 128),
                                                   batch_size=32,
                                                   class_mode='binary')
</code></pre><p>å¾ˆå®¹æ˜“ç†è§£å§ï¼Œè¿™é‡Œçš„ä»£ç ä¸»è¦æ¥è‡ªäº Keras çš„å®˜æ–¹æ–‡æ¡£ã€‚<br>æˆ‘æ‰“ç®—é‡‡ç”¨ (128, 128, 3) çš„æ ¼å¼è¾“å…¥å­¦ä¹ æ•°æ®ï¼Œæ¯æ‰¹ä¸ªæ•°ä¸º 32ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ³æ³•è¿›è¡Œè°ƒæ•´ã€‚<br>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºã€‚</p><pre><code>Found 8000 images belonging to 2 classes.
Found 2000 images belonging to 2 classes.
</code></pre><h1 id=æ„å»ºç½‘ç»œ>æ„å»ºç½‘ç»œ</h1><p>ä¸€ä¸ªç®€å•çš„å·ç§¯ç½‘ç»œ<br>3 ä¸ªå·ç§¯å±‚ï¼Œæ¯æ¬¡éƒ½è¿›è¡Œæ± åŒ–ï¼Œå…¨è¿æ¥å±‚ä¹ æƒ¯æ€§ç”¨2ä¸ªã€‚</p><pre><code class=language-python>def build_nn():
    # Build the CNN
    model = Sequential()

    model.add(Conv2D(32, (3, 3), padding='same', activation='relu', kernel_initializer='he_uniform', input_shape=(128, 128, 3)))
    model.add(MaxPooling2D(pool_size=(2, 2)))

    model.add(Conv2D(64, (3, 3), padding='same', activation='relu', kernel_initializer='he_uniform'))
    model.add(MaxPooling2D(pool_size=(2, 2)))

    model.add(Conv2D(128, (3, 3), padding='same', activation='relu', kernel_initializer='he_uniform'))
    model.add(MaxPooling2D(pool_size=(2, 2)))

    model.add(Flatten())

    model.add(Dense(256, activation='relu'))
    model.add(Dropout(0.2))

    model.add(Dense(128, activation='relu'))
    model.add(Dropout(0.2))

    model.add(Dense(1, activation='sigmoid'))
    
    return model
</code></pre><h1 id=åˆå§‹åŒ–-tpu-ç¯å¢ƒ>åˆå§‹åŒ– TPU ç¯å¢ƒ</h1><p>å…ˆå–å¾— TPU çš„ä½ç½®ï¼Œè¿™å¥—ç”¨æ³•åŸºæœ¬ä¸Šæ˜¯å›ºå®šçš„ï¼Œæ¯æ¬¡è¦ç”¨çš„æ—¶å€™ copy-paste å°±è¡Œã€‚</p><pre><code class=language-python># Initialize TPU
tpu_grpc_url = &quot;grpc://&quot;+os.environ[&quot;COLAB_TPU_ADDR&quot;]
tpu_cluster_resolver = tf.contrib.cluster_resolver.TPUClusterResolver(tpu_grpc_url)
strategy = keras_support.TPUDistributionStrategy(tpu_cluster_resolver)
</code></pre><p>æˆåŠŸè¿è¡Œçš„è¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ˜¾ç¤ºè¿”å›åˆ°äº†åœ°å€ï¼Œç„¶åä»åœ°å€å»è·å–è®¾å¤‡ä¿¡æ¯ï¼Œ1 Worker 8 Core çš„ TPUã€‚æ³¨æ„è¿™ä¸ªæ•°å­—ï¼Œå› ä¸ºè¿™æ„å‘³ä¹‹åæµ‹è¯•é›†éœ€è¦ç»„æˆ batch ä¸º 8 çš„å€æ•°æ‰èƒ½ä¼ å…¥ã€‚</p><pre><code>INFO:tensorflow:Querying Tensorflow master (grpc://10.110.24.138:8470) for TPU system metadata.
INFO:tensorflow:Found TPU system:
INFO:tensorflow:*** Num TPU Cores: 8
INFO:tensorflow:*** Num TPU Workers: 1
INFO:tensorflow:*** Num TPU Cores Per Worker: 8
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:CPU:0, CPU, -1, 14991867850935745303)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:XLA_CPU:0, XLA_CPU, 17179869184, 4977701856257024240)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:0, TPU, 17179869184, 799391477980569210)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:1, TPU, 17179869184, 7413645770321013063)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:2, TPU, 17179869184, 12127959108352401067)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:3, TPU, 17179869184, 9301267841357501458)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:4, TPU, 17179869184, 2329118821990200537)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:5, TPU, 17179869184, 6102181154716035854)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:6, TPU, 17179869184, 6202014608559033004)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU:7, TPU, 17179869184, 7250002334323814010)
INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:worker/replica:0/task:0/device:TPU_SYSTEM:0, TPU_SYSTEM, 8589934592, 16188795321964965491)
</code></pre><h1 id=è®­ç»ƒå‰çš„å‡†å¤‡>è®­ç»ƒå‰çš„å‡†å¤‡</h1><p>ç»ˆäºåˆ°äº†è¦è®­ç»ƒçš„æ—¶å€™ï¼Œä¸è¿‡æ³¨æ„ï¼ŒTPU çš„æ¨¡å‹ä¸åŒäº GPU å’Œ CPU çš„æ¨¡å‹å…³ç³»ï¼ŒTPU æ¨¡å‹éœ€è¦ç‰¹æ®Šçš„è½¬æ¢æ‰èƒ½è·‘ï¼Œè€Œä¸”æ¨¡å‹ä¹Ÿä¼šæŸå¤±æ‰éƒ¨åˆ†æ–¹æ³•ï¼Œä¹‹å‰æˆ‘ä»¬é™çº§å®é™…ä¸Šå°±æ˜¯ä¸ºäº†ä½¿ç”¨åœ¨ 1.14 ä¸­ç›®å‰ä¸æ”¯æŒçš„å‡½æ•°ã€‚ç›¸ä¿¡ä¹‹å TPU çš„æ—¶å€™ä¼šè¶Šæ¥è¶Šæ–¹ä¾¿ï¼Œæ¯•ç«Ÿç°åœ¨è¿˜å¤„äºå‘å±•åˆæœŸã€‚</p><pre><code class=language-python># Convert cpu model to tpu model
myOptimizer = tf.keras.optimizers.SGD(lr=0.01, momentum=0.7)
my_cnn = build_nn()
my_cnn.compile(optimizer=myOptimizer, loss='binary_crossentropy', metrics=['accuracy'])
my_cnn = tf.contrib.tpu.keras_to_tpu_model(my_cnn, strategy=strategy)
</code></pre><p>è¿™æ®µä»£ç ä¸­æœ‰ä¸ªéå¸¸å®¹æ˜“è¢«å¿½è§†çš„ç‚¹ï¼Œé‚£å°±æ˜¯optimizerå¿…é¡»ä½¿ç”¨åˆ° TensorFlow çš„ï¼Œè€Œä¸æ˜¯ Keras çš„ï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™å“¦ï¼æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>Adam</code> ç®—æ³•ï¼Œè¿™é‡Œç‰¹åˆ«è¯´ä¸‹ï¼Œå¸¸ç”¨çš„éšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰ç›®å‰åœ¨ TensorFlow ä¸­æ˜ å°„åˆ° keras æ”¯æŒæ¨¡å—ï¼Œä¸èƒ½ç›´æ¥æ‹¿æ¥ç”¨ã€‚</p><pre><code class=language-python># Convert CPU model to TPU model
myOptimizer = tf.train.AdamOptimizer()
my_cnn = build_nn()
my_cnn.compile(optimizer=myOptimizer, loss='binary_crossentropy', metrics=['accuracy'])
my_cnn = tf.contrib.tpu.keras_to_tpu_model(my_cnn, strategy=strategy)
</code></pre><p>æ‰§è¡ŒæˆåŠŸçš„è¯å°±ä¼šçœ‹åˆ°ä¸‹é¢çš„æ–‡å­—ï¼š</p><pre><code>WARNING:tensorflow:tpu_model (from tensorflow.contrib.tpu.python.tpu.keras_support) is experimental and may change or be removed at any time, and without warning.
</code></pre><h1 id=è®­ç»ƒå’–å•¡æ—¶é—´>è®­ç»ƒï¼Œå’–å•¡æ—¶é—´</h1><p><code>epoch</code> è¦å¤šå°‘è‡ªå·±çœ‹ç€è®¾å®šï¼Œç¬¬ä¸€è½®è®­ç»ƒå…¶å®æ˜¯è¾ƒæ…¢çš„ï¼Œç¬¬äºŒæ¬¡å¼€å§‹æ—¶ï¼Œé€Ÿåº¦æ¯”èµ·ä¼ ç»Ÿ GPU è®­ç»ƒå¯ä»¥è¯´æ˜¯éå¸¸ä¹‹å¿«é€Ÿäº†ã€‚</p><pre><code class=language-python># Train!
my_cnn.fit_generator(train_data,
                     steps_per_epoch=8000,
                     epochs=10,
                     validation_data=validation_data,
                     validation_steps=2000)
</code></pre><h1 id=ä¿å­˜æƒé‡>ä¿å­˜æƒé‡</h1><p>å°½é‡ä¸è¦ç›´æ¥ä½¿ç”¨ä¿å­˜å…¨ç½‘ç»œçš„å‡½æ•°ï¼Œä¿å­˜æƒé‡å³å¯ã€‚<br>æµ‹è¯•å¯ä»¥åœ¨æœ¬åœ°æ„å»ºä¸€ä¸ª CPU æ¨¡å‹å¯¼å…¥æƒé‡æ¥è¿›è¡Œæµ‹è¯•ã€‚</p><pre><code class=language-python>classifier.save_weights('weights.h5', overwrite=True)
</code></pre><h1 id=ç»“è®º>ç»“è®º</h1><p>ä¸“ç”¨ç¡¬ä»¶è®­ç»ƒç½‘ç»œä½“éªŒçœŸçš„å¾ˆæ£’ï¼åªæ˜¯ç°åœ¨å¤–éƒ¨è½¯ä»¶æ”¯æŒè¿˜æ²¡æœ‰åšçš„å¾ˆå¥½ï¼Œä½†æ˜¯è¶³ä»¥è®©äººæœŸå¾…ä¹‹åçš„è¡¨ç°çš„ã€‚<br>æ·±åº¦å­¦ä¹ ä»å‡ å¹´å‰çš„å®è£…å›°éš¾ï¼Œåˆ°ç°åœ¨ç®€å•å‡ å¥å°±èƒ½å¼€å§‹è®­ç»ƒï¼Œç¡®ç¡®å®å®ä»å­¦æœ¯ç•Œæ™®åŠåˆ°äº†æ—¥å¸¸ç”Ÿæ´»ä¹‹ä¸­ã€‚å¾ˆå¤šåˆå­¦è€…æ‰‹ä¸Šæ²¡æœ‰è¶³å¤Ÿçš„ç¡¬ä»¶å¯¼è‡´å­¦ä¹ æ•ˆç‡ä½ä¸‹ï¼Œç›¸ä¿¡éšç€èŠ¯ç‰‡æŠ€æœ¯çš„å‘å±•ï¼Œè¿™ä¸ªé—®é¢˜å°†ä¸å¤å­˜åœ¨ã€‚</p></div><div class=post-footer><div class=info><span class=separator><a class=tag href=/tags/cnn/>CNN</a><a class=tag href=/tags/deep-learning/>Deep Learning</a><a class=tag href=/tags/tpu/>TPU</a></span></div></div></div></div></div></div><script type=text/javascript src=/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin=anonymous></script></body></html>